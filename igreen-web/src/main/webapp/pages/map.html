<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title></title>
    <style>
    html,
    body,
    #container {
        width: 100%;
        height: 100%;
        margin: 0px;
    }

    #loadingTip {
        position: absolute;
        z-index: 9999;
        top: 0;
        left: 0;
        padding: 3px 10px;
        background: red;
        color: #fff;
        font-size: 14px;
    }
    </style>
     <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.1&key=cf8988101dc58dbe81ba76c1e7f829d1&plugin=AMap.Geocoder"></script>
</head>

<body>
    <div style="margin-bottom: 10px;">
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
             清洁生产企业数量:<input name="type" type="radio" value="1" checked="true" onclick="getRegions(1)"/>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       
             排污许可证数量 :<input name="type" type="radio" value="2" onclick="getRegions(2)"/>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
             处罚记录数量:<input name="type" type="radio" value="3" onclick="getRegions(3)"/>
    </div>
    <div id="container"></div>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.1&key=cf8988101dc58dbe81ba76c1e7f829d1"></script>
    <!-- UI组件库 1.0 -->
    <script src="http://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
    <script type="text/javascript">
    //创建地图
    var map = new AMap.Map('container', {
        zoom: 4
    });
    var alldata=new Array();      
    
    function initPage(DistrictCluster, PointSimplifier, $) { 
        var pointSimplifierIns = new PointSimplifier({
            map: map, //所属的地图实例
            zIndex: 110,
            autoSetFitView: false, //禁止自动更新地图视野
            getPosition: function(item) {
                return item.position;
            },
            renderOptions: {
                //点的样式
                pointStyle: {
                    width: 6,
                    height: 6,
                    fillStyle: 'rgba(153, 0, 153, 0.38)'
                },
                //鼠标hover时的title信息
                hoverTitleStyle: {
                    position: 'top'
                }
            }
        });

        var distCluster = new DistrictCluster({
            zIndex: 100,
            map: map, //所属的地图实例

            getPosition: function(item) {

                if (!item) {
                    return null;
                }

                var parts = item.split(',');
                //返回经纬度
                return [parseFloat(parts[0]), parseFloat(parts[1])];
            },
            renderOptions: {
                //基础样式
                featureStyle: {
                    fillStyle: 'rgba(102,170,0,0.5)', //填充色
                    lineWidth: 2, //描边线宽
                    strokeStyle: 'rgb(31, 119, 180)', //描边色
                    //鼠标Hover后的样式
                    hoverOptions: {
                        fillStyle: 'rgba(255,255,255,0.2)'
                    }
                }
            }
               
        });

        var currentAdcode = null;

        //监听区划面的点击
        distCluster.on('featureClick', function(e, feature) {
            currentAdcode = feature.properties.adcode;
           /* //获取该节点的聚合信息
            distCluster.getClusterRecord(currentAdcode, function(error, result) {

                //currentAdcode已经更新，有新的点击
                if (result.adcode !== currentAdcode) {
                    return;
                }

                //设置数据
                pointSimplifierIns.setData(result.dataItems);
            })*/
        });
        distCluster.on('renderFinish', function(e, result) {
        	
        	
            var features = result.features, //当前绘制的features
                currentAdcodeExists = false;

            for (var i = 0, len = features.length; i < len; i++) {
                if (currentAdcode === features[i].properties.adcode) {

                    currentAdcodeExists = true;
                    break;
                }
            }
            

            if (!currentAdcodeExists) {
                //如果当前adcode没有绘制，清除？
                //pointSimplifierIns.setData(null);
            }
        });
        distCluster.on('clusterMarkerClick', function(e, record) {
        	if(record.feature.properties.level != 'district'){
	        	map.clearMap();
	        	 //加载行政区划插件
	            AMap.service('AMap.DistrictSearch', function() {
	                var opts = {
	                    subdistrict: 1,   //返回下一级行政区
	                    extensions: 'all',  //返回行政区边界坐标组等具体信息
	                    level: 'city'  //查询行政级别为 市
	                };
	                //实例化DistrictSearch
	                district = new AMap.DistrictSearch(opts);  
	                district.setLevel('district');
	                //行政区查询
	                district.search(record.feature.properties.name, function(status, result) {
	                    var bounds = result.districtList[0].boundaries;
	                    var polygons = [];
	                    if (bounds) {
	                        for (var i = 0, l = bounds.length; i < l; i++) {
	                            //生成行政区划polygon
	                            var polygon = new AMap.Polygon({
	                                map: map,
	                                strokeWeight: 1,
	                                path: bounds[i],
	                                fillOpacity: 0.7,
	                                fillColor: '#CCF3FF',
	                                strokeColor: '#CC66CC'
	                            });
	                            polygons.push(polygon);
	                        }
	                    }
	                });
	            });
        	 }
        });

        window.distCluster = distCluster;

        function refresh() {
 
            var zoom = map.getZoom();
            //获取 pointStyle
            var pointStyle = pointSimplifierIns.getRenderOptions().pointStyle;
            
            //根据当前zoom调整点的尺寸
            pointStyle.width = pointStyle.height = 2 * Math.pow(1.2, map.getZoom() - 3);
            // var zoom = map.getZoom();

            // if (zoom < 10) {

            //     pointSimplifierIns.hide();

            // } else {

            //     pointSimplifierIns.show();
            // }
        }

        map.on('zoomend', function() {
            refresh();
        });

        refresh();
        $('<div id="loadingTip">加载数据，请稍候...</div>').appendTo(document.body);
        getRegions(1);        
      
    }
    
    function getRegions(type){
		$.ajax({
		    type: 'get',
		    data: "type="+type,
		    contentType : 'application/json',
		    url: window.location.origin+'/index/getmap',
		    dataType: "json",
		    success: function(obj){
		       if(obj.data != null){
		    	   distCluster.setData(obj.data);
		    	   $('#loadingTip').remove();
		       }
		    },
		    error:function (obj) {
		    	//console.log(data);
		    }
		})
	}
    
   
    
    function loadgeocoder(list){
    	AMap.service('AMap.Geocoder',function(){//回调函数
    	    //实例化Geocoder
    	    geocoder = new AMap.Geocoder({
    	        radius: 500 //范围，默认：500
    	    });
    	    //TODO: 使用geocoder 对象完成相关功能
    	    for(var i=0;i<list.length;i++){
	    	    geocoder.getLocation(list[i], function(status, result) {
	                if (status === 'complete' && result.info === 'OK') {
	                     //地理编码结果数组
	                     var geocode = result.geocodes;
	                     //拼接输出html
	                     var lng = geocode[0].location.getLng(); 
	                     var lat = geocode[0].location.getLat();
	                     alldata.push(lng+","+lat)
	                }
	            });
    	    }
    	    distCluster.setData(alldata);
    	    setTimeout(function(){
    	    	distCluster.setData(alldata);
    	    },10000)
    	})
        //地理编码,返回地理编码结果
        
    }
    
    //加载相关组件
    AMapUI.load(['ui/geo/DistrictCluster', 'ui/misc/PointSimplifier', 'lib/$'], function(DistrictCluster, PointSimplifier, $) {
        //启动页面
        initPage(DistrictCluster, PointSimplifier, $);
    });
    </script>
</body>

</html>